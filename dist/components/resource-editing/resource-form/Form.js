"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},_=require("lodash"),React=require("react/addons"),validator=require("validator"),isEmpty=require("../../../utils/isEmpty"),Row=require("../../page-structure/Row"),Column=require("../../page-structure/Column"),FormActions=require("../../../actions/FormActionCreators"),FormValidator=require("./FormValidator"),FormStore=require("../../../stores/FormStore"),Form=React.createClass({displayName:"Form",propTypes:{formKey:React.PropTypes.string.isRequired,bindResource:React.PropTypes.oneOfType([React.PropTypes.object,React.PropTypes.array]).isRequired,onSubmit:React.PropTypes.func,schema:React.PropTypes.object},getInitialState:function(){return{isValid:!0,boundResource:{}}},boundResource:{},validator:null,syncBoundResource:function(e,r){this.props.bindResourceCallback(e,this.state.isValid)},componentDidMount:function(){var e=this;e.props.schema&&(e.validator=new FormValidator(e.props.schema)),e.setState({boundResource:e.props.bindResource},function(){!isEmpty(e.state.boundResource)&&e.props.schema?e.validateAndRegisterFormAgainstSchema():FormActions.registerForm(e.props.formKey,e.props.bindResource)})},componentWillReceiveProps:function(e){this.boundResource=e.bindResource,this.setState({boundResource:e.bindResource})},componentWillMount:function(){this.traverseChildren(this.props.children)},componentWillUnmount:function(){this.boundResource={}},handleChange:function(e,r,o){var t=this;if(t.props.schema){var i=_.cloneDeep(FormStore.getResource(t.props.formKey));_.set(i,e,r);var n=t.validator.validate(i);if(n){var s=t.getNestedFieldKeys(n);s.forEach(function(e){FormActions.editField(t.props.formKey,e,_.get(i,e),!1)}),s.includes(e)||FormActions.editField(t.props.formKey,e,r,!0)}else FormActions.editField(t.props.formKey,e,r,!0)}else{var a=t.validate(e,r);FormActions.editField(t.props.formKey,e,r,a)}},validateAndRegisterFormAgainstSchema:function(){var e,r=this,o={},t=this.state.boundResource,i=r.validator.validate(t);if(i){var n=r.getNestedFieldKeys(i);e=!1,n.forEach(function(e){o[e]=!1})}FormActions.registerForm(this.props.formKey,t,o,e)},getNestedFieldKeys:function(e){var r=this;return Object.keys(e).map(function(o){return"object"===_typeof(e[o])?r.getNestedFieldKeys(e[o]).map(function(e){return o+"."+e}):o}).reduce(function(e,r){return e.concat(r)},[])},determineColumnSize:function(){var e=React.Children.count(this.props.children);return Math.floor(12/e)},formFields:{},validate:function(e,r){var o=this.formFields[e];if(o.required&&(!r||r.length<1))return!1;if(!o.validations)return!0;var t=!0;return(r||o.required===!0)&&o.validations.split(",").forEach(function(e){var o=e.split(":"),i=o.shift();o=o.map(function(e){return JSON.parse(e)}),o=[r].concat(o),validator[i].apply(validator,o)||(t=!1)}),t},validateForm:function(){this.setState({isValid:FormStore.isFormValid()})},traverseChildren:function(e){return React.Children.map(e,function(r){if(!r||!r.props)return r;if(e.props&&"function"==typeof e.props.changeCallback)var o=e.props.changeCallback;else var o=this.handleChange;return r.props.fieldKey&&(r=React.addons.cloneWithProps(r,{changeCallback:o,bindResource:this.props.bindResource,formKey:this.props.formKey}),this.formFields[r.props.fieldKey]={validations:r.props.validations||!1,required:r.props.required?!0:!1,isValid:FormStore.isFieldValid(this.props.formKey,r.props.fieldKey)}),r.props.children&&(r=React.addons.cloneWithProps(r,{children:this.traverseChildren(r.props.children)})),r}.bind(this))},handleSubmit:function(e){e.preventDefault(),this.props.onSubmit?this.props.onSubmit(e):void 0},render:function(){return React.createElement("form",{role:"form",onSubmit:this.handleSubmit},this.traverseChildren(this.props.children))}});Form.Row=Row,Form.Column=Column,Form.Submit=require("./Submit"),Form.Input=require("./Input"),Form.FizzyWig=require("./FizzyWig"),Form.TextArea=require("./TextArea"),Form.TypeAheadInput=require("./TypeAheadInput"),Form.File=require("./FileInput"),Form.Toggle=require("./Toggle"),Form.Checkbox=require("./Checkbox"),Form.SelectBox=require("./SelectBox"),Form.RadioButtons=require("./RadioButtons"),Form.DropdownSelect=require("./DropdownSelect"),Form.DatePicker=require("./Time/DatePicker"),Form.TimePicker=require("./Time/TimePicker"),module.exports=Form;
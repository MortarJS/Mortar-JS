"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},_=require("lodash"),Fuse=require("fuse.js"),React=require("react/addons"),isEmpty=require("../../../utils/isEmpty"),className=require("classnames"),Input=require("./Input"),AppActionConstants=require("../../../constants/AppActionConstants"),ActionTypes=AppActionConstants.ActionTypes.cms.form,FormActionCreators=require("../../../actions/FormActionCreators"),FormStore=require("../../../stores/FormStore"),FormUtility=require("./FormUtilityMixin"),FormKeyMixin=require("../../../mixins/FormKeyMixin"),TypeAheadInput=React.createClass({displayName:"TypeAheadInput",propTypes:{fieldKey:React.PropTypes.string.isRequired,label:React.PropTypes.string,placeholder:React.PropTypes.string,helpText:React.PropTypes.string,limit:React.PropTypes.number,resourceAction:React.PropTypes.object,returnField:React.PropTypes.string,source:React.PropTypes.oneOfType([React.PropTypes.string,React.PropTypes.array]).isRequired,options:React.PropTypes.shape({dataNode:React.PropTypes.string,searchToken:React.PropTypes.string,queryTimeout:React.PropTypes.number,selectDisplay:React.PropTypes.func}),updateCallback:React.PropTypes.func,debug:React.PropTypes.bool},mixins:[FormUtility,FormKeyMixin],getInitialState:function(){return this.props.debug&&(console.log("Typeahead Input Debug Information:"),console.log("OPTIONS:"),console.table(this.props.options),console.log("SOURCE:"),console.table(this.props.source),console.log("LABEL:",this.props.label)),{formKey:"",isValid:!0,fieldValue:[],typeAhead:{query:"",queryResults:[]}}},componentDidMount:function(){var e=this._generateFormKey();this.setState({formKey:e}),FormStore.addChangeListener(this._onChange)},componentWillUnmount:function(){FormStore.removeChangeListener(this._onChange)},componentWillReceiveProps:function(e){this.setState({fieldValue:this._findValueByPath(e.bindResource,e.fieldKey)||[]})},componentDidUpdate:function(){"function"==typeof this.props.updateCallback&&this.props.updateCallback()},_onChange:function(){var e=this.state.typeAhead;e.queryResults=FormStore.getTypeaheadQueryData(this.state.formKey),this.setState({typeAhead:e})},_getDataLabel:function(e){return e.dataset.label||this._getDataLabel(e.parentElement)},customHandleChange:function(e){var t=this._getDataLabel(e.target),s=this.props.options||{},i=s.returnField||this.props.fields[0],a={};a[i]=t;var r=_.where(this.state.typeAhead.queryResults,a)[0],o=this.state.fieldValue;if("object"===("undefined"==typeof o?"undefined":_typeof(o)))var n=_.where(o,a).length>0;else var n=_.contains(a,o);var l=[];if(n)this.props.limit>1?o.forEach(function(e,s){e[i]!==t&&l.push(e)}):l=this.props.returnField?"":[];else if(this.props.limit>1){l=o;var p=this.props.returnField?r[this.props.returnField]:r;l.push(p)}else l=this.props.returnField?r[this.props.returnField]:r;var c=this.props.limit||l.length;if(c>1)var u=l.slice(0,c);else{var u=l;FormActionCreators.clearTypeaheadQueryData(this.state.formKey),this.setState({typeAhead:{query:""}})}this.setState({fieldValue:u},function(){this.props.changeCallback(this.props.fieldKey,this.state.fieldValue,this)})},buildSelectedBubbles:function(){if(!isEmpty(this.state.fieldValue)){var e,t=this.props.options||{},s=t.resultDisplayField||this.props.fields[0],i=this.state.fieldValue;return"object"===("undefined"==typeof i?"undefined":_typeof(i))&&i.length?this.state.fieldValue.map(function(i,a){return e="function"==typeof t.selectDisplay?t.selectDisplay(i):i[s],React.createElement("div",{key:a,className:"selected-option"},e,React.createElement("a",{href:"javascript:void(0)",className:"typeahead-unselect icon-times-circle-o pull-right",onClick:this.customHandleChange,"data-label":i[s]}))}.bind(this)):"object"===("undefined"==typeof i?"undefined":_typeof(i))?(e="function"==typeof t.selectDisplay?t.selectDisplay(i):i[s],React.createElement("div",{key:s,className:"selected-option"},e,React.createElement("a",{href:"javascript:void(0)",className:"typeahead-unselect icon-times-circle-o pull-right",onClick:this.customHandleChange,"data-label":i[s]}))):(e="function"==typeof t.selectDisplay?t.selectDisplay(i):i,React.createElement("div",{key:s,className:"selected-option"},e,React.createElement("a",{href:"javascript:void(0)",className:"typeahead-unselect icon-times-circle-o pull-right",onClick:this.customHandleChange,"data-label":i})))}},buildSelectOptions:function(){var e=this.props.options||{},t=e.resultDisplayField||this.props.fields[0];return!this.state.typeAhead.queryResults||this.state.typeAhead.queryResults.length<1?void 0:this.state.typeAhead.queryResults.map(function(s,i){if(e.selectDisplay)var a=e.selectDisplay(s);else var a=s[t];var r={};r[t]=s[t];var o=_.where(this.state.fieldValue,r).length>0,n=className({"btn btn-flat btn-sm":!o,"btn btn-default btn-raised btn-sm":o});return React.createElement("button",{className:n,key:i,href:"javascript:void(0)",onClick:this.customHandleChange,"data-label":s[t]},a)},this)},handleSearchChange:function(e,t,s){if(t.length<2)return void this.setState({typeAhead:{query:t,queryResults:[]}});var i=this.state.typeAhead;i[e]=t,"object"===_typeof(this.props.source)?(i.queryResults=this.where(this.props.source,i.query),this.setState({typeAhead:i})):"remote"===this.props.source&&this.remoteWhere(i.query)},buildFilters:function(e){var t,s={},i=this.props.options||{},a=i.searchToken||"~";return this.props.fields.forEach(function(i,r){t?(t.or={},t.or[i]=a+e,t=t.or):(s[i]=a+e,t=s)}),s},remoteWhere:function(e){if(""===e)return[];var t=this.props.options||{},s=t.include||[],i={modifiers:{include:s,filters:this.buildFilters(e)},dataNode:t.dataNode||"data",eventName:ActionTypes.TYPEAHEAD_QUERY,eventData:{formKey:this.state.formKey}};clearTimeout(this.currentTimeout),delete this.currentTimeout,this.currentTimeout=setTimeout(function(){this.props.resourceAction.listResource(i)}.bind(this),t.queryTimeout||500)},currentTimeout:0,where:function(e,t){if(""==t)return[];var s={keys:this.props.fields,threshold:.4},i=new Fuse(e,s);return i.search(t)},render:function(){var e=className({"form-group":!0,"has-error":this._checkFieldIsValid()});return React.createElement("div",{className:"typeahead-select"},React.createElement("div",{className:e},React.createElement("label",{className:"control-label"},this.props.label),React.createElement("br",null),this.buildSelectedBubbles(),React.createElement(Input,{fieldKey:"query",bindResource:this.state.typeAhead,changeCallback:this.handleSearchChange,placeholder:this.props.placeholder,type:"text"})),React.createElement("div",{className:"form-group"},React.createElement("div",{className:"typeahead-select",multiple:!0,onChange:this.customHandleChange},this.state.fieldValue&&this.state.fieldValue.length<1&&this._shouldRenderHelpBlock(this.props.helpText),this.buildSelectOptions())))}});module.exports=TypeAheadInput;